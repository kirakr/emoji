<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Character Ritual Tycoon - Save Edition</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --accent: #00ff88;
            --color-normal: #ffffff;
            --color-uncommon: #1eff00;
            --color-rare: #0070dd;
            --color-epic: #a335ee;
            --color-legend: #ff8000;
            --color-god: #ffb100;
            --color-secret: #e6cc80;
            --color-original: #ff0000;
            --price: #ffeb3b;
            --error: #ff4444;
        }
        body { font-family: 'Arial Black', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; user-select: none; }
        #flash-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: red; opacity:0; pointer-events:none; z-index: 1000; }
        .flash-anim { animation: flash-effect 0.5s ease-out; }
        @keyframes flash-effect { 0% { opacity: 0.7; } 100% { opacity: 0; } }
        #wanted-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.9); color: white; padding: 20px 40px; border: 4px solid white; z-index: 999; text-align: center; display: none; box-shadow: 0 0 50px red; pointer-events: none; }
        #hud { display: flex; justify-content: space-around; background: #000; padding: 10px; border-bottom: 3px solid var(--accent); z-index: 100; }
        .stat-box { font-size: 1rem; text-shadow: 0 0 5px var(--accent); }
        #game-world { display: flex; height: calc(100vh - 55px); }
        #conveyor-area { width: 25%; border-right: 2px dashed #444; position: relative; overflow: hidden; background: #111; }
        .conveyor-line { position: absolute; width: 80px; height: 100%; left: 50%; transform: translateX(-50%); background: #1a1a1a; border-left: 5px solid #333; }
        .meme-container { position: absolute; z-index: 10; cursor: pointer; text-align: center; width: 120px; }
        .meme-label { background: rgba(0,0,0,0.9); border: 2px solid #fff; border-radius: 6px; padding: 4px; font-size: 0.6rem; margin-bottom: 5px; }
        #base-area-container { width: 50%; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        #base-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; justify-items: center; }
        
        .slot { width: 115px; height: 150px; background: #1a1a1a; border: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding: 8px 5px 5px 5px; border-radius: 12px; position: relative; transition: 0.2s; box-sizing: border-box; }
        .slot.locked { background: #000; border: 2px dashed #222; opacity: 0.3; justify-content: center; height: 150px; }
        .slot-emoji { font-size: 2.2rem; margin-bottom: 2px; cursor: pointer; transition: transform 0.2s; z-index: 2; }
        
        .slot.occupied:hover { background: #301010; border-color: var(--error); }
        .slot.occupied:hover .slot-emoji { transform: scale(1.1); filter: drop-shadow(0 0 5px red); }
        .slot.occupied::before { content: "SELL"; position: absolute; top: 5px; right: 5px; background: var(--error); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; opacity: 0; transition: 0.2s; z-index: 3; pointer-events: none; font-weight: bold; }
        .slot.occupied:hover::before { opacity: 1; }

        .slot-name { font-size: 0.65rem; color: #fff; white-space: nowrap; overflow: hidden; width: 95%; pointer-events: none; font-weight: bold; }
        .slot-profit-rate { font-size: 0.6rem; color: #aaa; margin-bottom: 6px; pointer-events: none; }

        .collect-btn { 
            background: var(--accent); color: black; border: none; border-radius: 6px; 
            font-size: 0.9rem; font-weight: 900; padding: 10px 0; width: 100%; cursor: pointer; 
            margin-top: auto; z-index: 10; box-shadow: 0 3px 0 #009955; 
            transition: transform 0.05s, background 0.2s;
        }
        .collect-btn:hover { background: #00ffaa; }
        .collect-btn:active { transform: translateY(3px); box-shadow: none; }
        .collect-btn:disabled { background: #333; color: #666; box-shadow: none; transform: none; cursor: default; }

        #raid-area { width: 25%; border-left: 2px solid #444; padding: 10px; text-align: center; background: #0f0f0f; display: flex; flex-direction: column; }
        #rebirth-panel { background: #111; border: 2px solid #333; border-radius: 10px; padding: 10px; margin-top: 5px; }
        .condition { font-size: 0.75rem; margin: 4px 0; }
        .main-btn { background: var(--accent); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 95%; font-size: 1rem; color: #000; margin-bottom: 10px; }
        .book-btn { background: #333; color: white; border: 1px solid #555; }
        #book-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; overflow-y: auto; padding: 40px 20px; }
        .book-content { max-width: 900px; margin: 0 auto; }
        .book-rarity-section { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .book-card { background: #111; border: 1px solid #444; border-radius: 8px; padding: 10px; text-align: center; transition: 0.3s; }
        .book-card.unknown { opacity: 0.3; filter: grayscale(100%) blur(1px); }
        .book-card.unknown .emoji-book { filter: brightness(0); }
        .close-book { position: fixed; top: 20px; right: 20px; background: var(--error); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 2100; }
        .met { color: var(--accent); }
        .not-met { color: var(--error); }
    </style>
</head>
<body>
    <div id="flash-overlay"></div>
    <div id="wanted-overlay"><h1>âš ï¸ WANTED âš ï¸</h1><p>5ç§’å¾Œã«ã“ã®è¡¨ç¤ºã¯æ¶ˆãˆã¾ã™</p><h2 id="wanted-timer">180s</h2></div>
    <div id="book-modal">
        <button class="close-book" onclick="toggleBook()">é–‰ã˜ã‚‹</button>
        <div class="book-content">
            <h1 style="color:var(--accent); text-align: center;">ğŸ“œ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›³é‘‘ (å…¨87ä½“)</h1>
            <div id="book-list"></div>
        </div>
    </div>
    <div id="hud">
        <div class="stat-box">ğŸ’° $<span id="money">100</span></div>
        <div class="stat-box">âš¡ $<span id="pps">0</span>/s</div>
        <div class="stat-box">ğŸ’ Rebirth: <span id="rebirth">0</span>/6</div>
    </div>
    <div id="game-world">
        <div id="conveyor-area"><div class="conveyor-line"></div><div id="items-container"></div></div>
        <div id="base-area-container">
            <h3 style="margin: 5px 0;">MY BASE</h3>
            <div id="base-grid"></div>
            <div id="rebirth-panel">
                <h4 style="margin: 0 0 5px 0; color: var(--accent); font-size: 0.9rem;">ğŸ”„ è»¢ç”Ÿæ¡ä»¶</h4>
                <div id="cond-money" class="condition"></div>
                <div id="cond-item" class="condition"></div>
                <button onclick="rebirth()" id="rebirth-btn" class="main-btn">è»¢ç”Ÿå„€å¼ã‚’é–‹å§‹</button>
            </div>
        </div>
        <div id="raid-area">
            <h3>BLACK MARKET</h3>
            <div style="font-size: 2.5rem; margin: 10px;">ğŸ•µï¸â€â™‚ï¸</div>
            <button id="raid-btn" class="main-btn" onclick="raid()">ç›—ã‚€ (10%)</button>
            <div style="margin-top: auto;">
                <button class="main-btn book-btn" onclick="toggleBook()">ğŸ“– ã‚­ãƒ£ãƒ©å›³é‘‘ã‚’è¦‹ã‚‹</button>
                <button class="main-btn" style="background:#555; color:white; font-size:0.7rem; padding:5px;" onclick="resetSave()">âš ï¸ ã‚»ãƒ¼ãƒ–åˆæœŸåŒ–</button>
            </div>
        </div>
    </div>

    <script>
        let money = 100;
        let rebirths = 0;
        let myItems = [];
        let discoveredChars = new Set();
        let isRaidLocked = false;
        let spawnCounter = 0;
        let lastSpawnTop = -200;
        const baseSlots = 6;
        const absoluteMaxSlots = 12;

        const charDatabase = {
            "ãƒãƒ¼ãƒãƒ«": [{name:"ã‚¬ã‚¤ã‚³ãƒ„", emoji:"ğŸ’€", power:1.0}, {name:"çŸ³åƒ", emoji:"ğŸ—¿", power:1.1}, {name:"ãƒ‹ã‚³ã¡ã‚ƒã‚“", emoji:"ğŸ™‚", power:0.9}, {name:"çŸ³ã“ã‚", emoji:"ğŸª¨", power:0.5}, {name:"é›‘è‰", emoji:"ğŸŒ¿", power:0.8}, {name:"ãƒãƒˆ", emoji: "ğŸ•Šï¸", power:1.2}, {name:"ç©ºãç¼¶", emoji:"ğŸ¥«", power:0.4}, {name:"ãƒœãƒ­é´", emoji:"ğŸ‘Ÿ", power:0.6}, {name:"ãƒã‚¸", emoji:"ğŸ”©", power:0.7}, {name:"ãƒŸãƒŸã‚º", emoji:"ğŸª±", power:0.8}, {name:"æ¯ã‚Œè‘‰", emoji:"ğŸ‚", power:0.5}, {name:"åœŸå¡Š", emoji:"ğŸ’©", power:1.3}, {name:"ç´™å±‘", emoji:"ğŸ“„", power:0.4}, {name:"é‡˜", emoji:"ğŸ“", power:0.9}, {name:"ã‚¢ãƒª", emoji:"ğŸœ", power:1.1}, {name:"å°æ", emoji:"ğŸ¥¢", power:0.7}, {name:"ãƒœã‚¿ãƒ³", emoji:"ğŸ”˜", power:1.0}, {name:"ç¨®", emoji:"ğŸŒ±", power:1.2}],
            "çã—ã„": [{name:"ã‚­ãƒã‚³", emoji:"ğŸ„", power:1.1}, {name:"å¹¼è™«", emoji:"ğŸ›", power:0.9}, {name:"é»’çŒ«", emoji:"ğŸˆâ€â¬›", power:1.2}, {name:"ã‚¯ãƒ­ãƒ¼ãƒãƒ¼", emoji:"ğŸ€", power:1.5}, {name:"ã‚µãƒœãƒ†ãƒ³", emoji:"ğŸŒµ", power:1.0}, {name:"é¢¨èˆ¹çŠ¬", emoji:"ğŸˆ", power:0.8}, {name:"ã‚ªã‚¦ãƒ ", emoji:"ğŸ¦œ", power:1.1}, {name:"ãƒ¡ã‚¬ãƒ", emoji:"ğŸ¤“", power:1.3}, {name:"ã‚¸ãƒˆç›®", emoji:"ğŸ¤¨", power:1.0}, {name:"ãƒˆã‚«ã‚²", emoji:"ğŸ¦", power:1.2}, {name:"ãƒ›ã‚¿ãƒ«", emoji:"ğŸ’¡", power:1.4}, {name:"è²æ®»", emoji:"ğŸš", power:0.9}, {name:"ã‚³ã‚¦ãƒ¢ãƒª", emoji:"ğŸ¦‡", power:1.1}, {name:"ã‚«ãƒ–ãƒˆè™«", emoji:"ğŸª²", power:1.3}, {name:"ãƒ†ãƒ³ãƒˆã‚¦ãƒ ã‚·", emoji:"ğŸ", power:1.0}, {name:"ãƒãƒ", emoji:"ğŸ", power:1.2}, {name:"ãƒªã‚¹", emoji:"ğŸ¿ï¸", power:1.1}, {name:"ã‚«ãƒ¡", emoji:"ğŸ¢", power:0.9}],
            "ãƒ¬ã‚¢": [{name:"å®‡å®™çŒ«", emoji:"ğŸˆ", power:1.4}, {name:"æ‚²ã—ãè›™", emoji:"ğŸ¸", power:1.0}, {name:"ãƒ‰ãƒ¼ã‚¸", emoji:"ğŸ•", power:1.2}, {name:"é‡‘åµ", emoji:"ğŸ¥š", power:1.8}, {name:"ãƒ¡ã‚«åŸ·äº‹", emoji:"ğŸ¤–", power:1.3}, {name:"ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³", emoji:"ğŸ¦„", power:1.5}, {name:"æ°·ç²¾éœŠ", emoji:"ğŸ§š", power:1.1}, {name:"ç«‹æ–¹ä½“", emoji:"ğŸ§Š", power:1.0}, {name:"å¹½éœŠæç¯", emoji:"ğŸ®", power:0.9}, {name:"ç«ã®ç‰", emoji:"â˜„ï¸", power:1.6}, {name:"æ°´æ™¶", emoji:"ğŸ”®", power:1.4}, {name:"å¤éŠ­", emoji:"ğŸª™", power:1.7}, {name:"åŒ–çŸ³", emoji:"ğŸ¦´", power:1.2}, {name:"å®ç®±", emoji:"ğŸ“¦", power:1.5}, {name:"ç¾…é‡ç›¤", emoji:"ğŸ§­", power:1.1}],
            "ã‚¨ãƒ”ãƒƒã‚¯": [{name:"åœ°ç„é“åŒ–å¸«", emoji:"ğŸ¤¡", power:1.0}, {name:"ç‡ƒãˆã‚‹é—˜é­‚", emoji:"ğŸ”¥", power:1.5}, {name:"ç´”ç²‹é‡‘å‰›", emoji:"ğŸ’", power:1.8}, {name:"æ··æ²Œå¬å–šå¸«", emoji:"ğŸ§™", power:1.4}, {name:"é»„é‡‘ã‚¹ã‚«ãƒ©ãƒ™", emoji:"ğŸª²", power:1.6}, {name:"ã‚µã‚¤ãƒãƒ¼å¿è€…", emoji:"ğŸ¥·", power:1.3}, {name:"å†¥ç•Œã®é¦¬", emoji:"ğŸ", power:1.7}, {name:"å‘ªã„ã®äººå½¢", emoji:"ğŸ", power:1.2}, {name:"é›·é³¥", emoji:"ğŸ¦…", power:1.5}, {name:"æ·±æµ·é­š", emoji:"ğŸŸ", power:1.4}, {name:"é­”å°æ›¸", emoji:"ğŸ“–", power:1.9}, {name:"éŒ¬é‡‘é‡œ", emoji:"ğŸº", power:1.6}],
            "ä¼èª¬": [{name:"å¤ã®é¾", emoji:"ğŸ²", power:1.2}, {name:"ç‹åº§ã®ä¸»", emoji:"ğŸ‘‘", power:1.8}, {name:"é›·ç¥ã®æ€’ã‚Š", emoji:"âš¡", power:1.5}, {name:"ä¸æ­»é³¥", emoji:"ğŸ¤", power:1.4}, {name:"æ·±æµ·è¦‡è€…", emoji:"ğŸ™", power:1.1}, {name:"å¤©ç©ºé¨å£«", emoji:"ğŸ›¡ï¸", power:1.3}, {name:"è–å‰£", emoji:"ğŸ—¡ï¸", power:1.9}, {name:"é­”çœ¼", emoji:"ğŸ§¿", power:1.6}, {name:"è³¢è€…ã®çŸ³", emoji:"ğŸ”´", power:2.0}],
            "ç¥": [{name:"å…¨çŸ¥ã®çœ¼", emoji:"ğŸ‘ï¸", power:1.5}, {name:"éŠ€æ²³å®ˆè­·è€…", emoji:"ğŸŒŒ", power:2.0}, {name:"å¾©è®èˆ¬è‹¥", emoji:"ğŸ‘º", power:1.4}, {name:"å¤ªé™½åŒ–èº«", emoji:"â˜€ï¸", power:1.8}, {name:"æ™‚ã‚’çµ±ã¹ã‚‹è€…", emoji:"â³", power:1.6}, {name:"å‘½ã®ç²¾éœŠ", emoji:"ğŸŒ³", power:1.2}],
            "ç§˜å¯†": [{name:"ãƒã‚°æ˜Ÿäºº", emoji:"ğŸ‘¾", power:2.5}, {name:"æ¬¡å…ƒã®æ¸¦", emoji:"ğŸŒ€", power:2.0}, {name:"æœªç¢ºèªç‰©ä½“", emoji:"â“", power:1.8}, {name:"è™šç„¡ã®å½±", emoji:"ğŸ‘¤", power:3.0}, {name:"è£ã®ä½äºº", emoji:"ğŸ‘¤", power:2.2}, {name:"ç¦æ–­ã®æœå®Ÿ", emoji:"ğŸ", power:1.5}],
            "ã‚ªãƒªã‚¸ãƒŠãƒ«": [{name:"ä¼èª¬ã®è¶…æ˜Ÿ", emoji:"ğŸŒŸ", power:1.5}, {name:"å¥ˆè½ã®é¬¼ç¥", emoji:"ğŸ‘¹", power:2.0}, {name:"æµ·ç¥ã®ä¸‰å‰æ§", emoji:"ğŸ”±", power:1.8}]
        };

        const rarities = [
            { name: "ãƒãƒ¼ãƒãƒ«", color: "var(--color-normal)", chance: 50, basePrice: 10, baseValue: 1 },
            { name: "çã—ã„", color: "var(--color-uncommon)", chance: 25, basePrice: 80, baseValue: 6 },
            { name: "ãƒ¬ã‚¢", color: "var(--color-rare)", chance: 15, basePrice: 450, baseValue: 40 },
            { name: "ã‚¨ãƒ”ãƒƒã‚¯", color: "var(--color-epic)", chance: 6, basePrice: 2500, baseValue: 200 },
            { name: "ä¼èª¬", color: "var(--color-legend)", chance: 3, basePrice: 20000, baseValue: 1500 },
            { name: "ç¥", color: "var(--color-god)", chance: 0.8, basePrice: 100000, baseValue: 8000 },
            { name: "ç§˜å¯†", color: "var(--color-secret)", chance: 0.19, basePrice: 600000, baseValue: 50000 },
            { name: "ã‚ªãƒªã‚¸ãƒŠãƒ«", color: "var(--color-original)", chance: 0.01, basePrice: 7000000, baseValue: 600000 }
        ];

        const rebirthRequirements = [
            { cost: 5000, targetName: "æ‚²ã—ãè›™" }, { cost: 30000, targetName: "åœ°ç„é“åŒ–å¸«" }, { cost: 200000, targetName: "ç‹åº§ã®ä¸»" }, { cost: 1500000, targetName: "éŠ€æ²³å®ˆè­·è€…" }, { cost: 12000000, targetName: "æ¬¡å…ƒã®æ¸¦" }, { cost: 150000000, targetName: "å¥ˆè½ã®é¬¼ç¥" }
        ];

        // --- ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ ---
        function saveGame() {
            const data = {
                money, rebirths, 
                myItems, 
                discoveredChars: Array.from(discoveredChars)
            };
            localStorage.setItem('ritualTycoonSave', JSON.stringify(data));
        }

        function loadGame() {
            const saved = localStorage.getItem('ritualTycoonSave');
            if (saved) {
                const data = JSON.parse(saved);
                money = data.money || 100;
                rebirths = data.rebirths || 0;
                myItems = data.myItems || [];
                discoveredChars = new Set(data.discoveredChars || []);
            }
        }

        function resetSave() {
            if(confirm("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('ritualTycoonSave');
                location.reload();
            }
        }
        // -------------------------

        function initGrid() {
            const grid = document.getElementById('base-grid');
            grid.innerHTML = "";
            for (let i = 0; i < absoluteMaxSlots; i++) {
                const slot = document.createElement('div');
                slot.id = `slot-${i}`;
                grid.appendChild(slot);
            }
        }

        function spawnItem() {
            if (lastSpawnTop < 0 && lastSpawnTop > -200) return;
            spawnCounter++;
            const container = document.getElementById('items-container');
            let selectedRarity;
            if (spawnCounter % 30 === 0) {
                const highRarities = rarities.slice(4);
                selectedRarity = highRarities[Math.floor(Math.random() * highRarities.length)];
            } else if (spawnCounter % 10 === 0) {
                const highRarities = rarities.slice(3);
                selectedRarity = highRarities[Math.floor(Math.random() * highRarities.length)];
            } else {
                let rand = Math.random() * 100;
                let cumulative = 0;
                selectedRarity = rarities[0];
                for (let r of rarities) { cumulative += r.chance; if (rand <= cumulative) { selectedRarity = r; break; } }
            }
            const chars = charDatabase[selectedRarity.name];
            const charObj = chars[Math.floor(Math.random() * chars.length)];
            const actualValue = Math.max(1, Math.floor(selectedRarity.baseValue * charObj.power));
            const div = document.createElement('div');
            div.className = 'meme-container';
            div.style.left = '50%'; div.style.top = '-200px'; div.style.transform = 'translateX(-50%)';
            div.innerHTML = `<div class="meme-label" style="border-color:${selectedRarity.color}">
                <span style="font-weight:bold;display:block;">${charObj.name}</span>
                $${selectedRarity.basePrice.toLocaleString()}<br>+$${actualValue}/s</div>
                <div style="font-size:2.5rem;">${charObj.emoji}</div>`;
            container.appendChild(div);
            let pos = -200;
            const animate = () => {
                pos += 0.5;
                div.style.top = pos + 'px';
                if (div.parentNode) lastSpawnTop = pos;
                if (pos < window.innerHeight) requestAnimationFrame(animate); else div.remove();
            };
            requestAnimationFrame(animate);
            div.onclick = () => {
                let max = baseSlots + rebirths;
                if (money >= selectedRarity.basePrice && myItems.length < max) {
                    money -= selectedRarity.basePrice;
                    discoveredChars.add(charObj.name);
                    myItems.push({ name: charObj.name, emoji: charObj.emoji, value: actualValue, rarity: selectedRarity.name, cost: selectedRarity.basePrice, storedMoney: 0 });
                    updateUI(); div.remove();
                    saveGame(); // è³¼å…¥æ™‚ã«ã‚»ãƒ¼ãƒ–
                }
            };
        }

        function updateUI() {
            let max = baseSlots + rebirths;
            let multiplier = (1 + rebirths);
            for (let i = 0; i < absoluteMaxSlots; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (!slot) continue;
                slot.innerHTML = "";
                if (i < myItems.length) {
                    const item = myItems[i];
                    slot.className = 'slot occupied';
                    slot.innerHTML = `<div class="slot-emoji" onclick="sellItem(${i})">${item.emoji}</div>
                        <div class="slot-name">${item.name}</div>
                        <div class="slot-profit-rate">+$${(item.value * multiplier).toLocaleString()}/s</div>
                        <button class="collect-btn" onclick="collectMoney(${i})" ${Math.floor(item.storedMoney)<=0?'disabled':''}>
                            $${Math.floor(item.storedMoney).toLocaleString()} å›å
                        </button>`;
                    const rData = rarities.find(r => r.name === item.rarity);
                    slot.style.boxShadow = `inset 0 0 10px ${rData.color}, 0 4px 10px rgba(0,0,0,0.5)`;
                } else if (i < max) {
                    slot.className = 'slot'; slot.innerText = "EMPTY"; slot.style.fontSize = "0.7rem"; slot.style.color = "#444";
                    slot.style.boxShadow = "none";
                } else {
                    slot.className = 'slot locked'; slot.innerText = "ğŸ”’"; slot.style.boxShadow = "none";
                }
            }
            document.getElementById('money').innerText = Math.floor(money).toLocaleString();
            document.getElementById('rebirth').innerText = rebirths;
            updateRebirthPanel();
        }

        function collectMoney(index) {
            let amount = Math.floor(myItems[index].storedMoney);
            if (amount > 0) { 
                money += amount; 
                myItems[index].storedMoney -= amount; 
                updateUI_Fast(); 
                saveGame(); // å›åæ™‚ã«ã‚»ãƒ¼ãƒ–
            }
        }

        setInterval(() => {
            let totalRate = 0;
            myItems.forEach(item => {
                let gain = item.value * (1 + rebirths);
                item.storedMoney += gain;
                totalRate += gain;
            });
            updateUI_Fast(); 
            document.getElementById('pps').innerText = totalRate.toLocaleString();
        }, 1000);

        function updateUI_Fast() {
            document.getElementById('money').innerText = Math.floor(money).toLocaleString();
            myItems.forEach((item, i) => {
                const btn = document.querySelector(`#slot-${i} .collect-btn`);
                if (btn) {
                    btn.innerText = `$${Math.floor(item.storedMoney).toLocaleString()} å›å`;
                    btn.disabled = Math.floor(item.storedMoney) <= 0;
                }
            });
        }

        function updateRebirthPanel() {
            const panel = document.getElementById('rebirth-panel');
            if (rebirths >= 6) { panel.innerHTML = "æœ€å¤§è»¢ç”Ÿé”æˆ"; return; }
            const req = rebirthRequirements[rebirths];
            const hasMoney = money >= req.cost;
            const hasItem = myItems.some(item => item.name === req.targetName);
            document.getElementById('cond-money').innerHTML = `é‡‘: <span class="${hasMoney?'met':'not-met'}">$${req.cost.toLocaleString()}</span>`;
            document.getElementById('cond-item').innerHTML = `ä¾›ç‰©: <span class="${hasItem?'met':'not-met'}">${req.targetName}</span>`;
            document.getElementById('rebirth-btn').disabled = !(hasMoney && hasItem);
        }

        function sellItem(index) {
            const it = myItems[index];
            money += Math.floor(it.cost / 2); 
            myItems.splice(index, 1); 
            updateUI();
            saveGame(); // å£²å´æ™‚ã«ã‚»ãƒ¼ãƒ–
        }

        function raid() {
            if (isRaidLocked) return;
            const btn = document.getElementById('raid-btn');
            btn.disabled = true;
            setTimeout(() => {
                if (Math.random() < 0.1) {
                    if (myItems.length < (baseSlots + rebirths)) {
                        const c = charDatabase["ç¥"][Math.floor(Math.random()*charDatabase["ç¥"].length)];
                        discoveredChars.add(c.name);
                        myItems.push({ name: c.name, emoji: c.emoji, value: 8000, rarity: "ç¥", cost: 100000, storedMoney: 0 });
                        updateUI();
                        saveGame(); // ç›—ã¿æˆåŠŸæ™‚ã«ã‚»ãƒ¼ãƒ–
                        alert("æˆåŠŸï¼ç¥ã‚’å¥ªå–ã—ãŸï¼");
                    }
                    btn.disabled = false;
                } else { triggerFailure(); }
            }, 800);
        }

        function triggerFailure() {
            isRaidLocked = true;
            document.getElementById('flash-overlay').classList.add('flash-anim');
            setTimeout(() => document.getElementById('flash-overlay').classList.remove('flash-anim'), 500);
            const wanted = document.getElementById('wanted-overlay');
            wanted.style.display = 'block';
            setTimeout(() => wanted.style.display = 'none', 5000);
            let timeLeft = 180;
            const btn = document.getElementById('raid-btn');
            const timer = setInterval(() => {
                timeLeft--; btn.innerText = `é€ƒèµ°ä¸­ ${timeLeft}s`;
                document.getElementById('wanted-timer').innerText = timeLeft + "s";
                if (timeLeft <= 0) { clearInterval(timer); isRaidLocked = false; btn.disabled = false; btn.innerText = "ç›—ã‚€ (10%)"; }
            }, 1000);
        }

        function rebirth() {
            const req = rebirthRequirements[rebirths];
            if (money >= req.cost && myItems.some(item => item.name === req.targetName)) {
                money = 100; myItems = []; rebirths++; 
                updateUI();
                saveGame(); // è»¢ç”Ÿæ™‚ã«ã‚»ãƒ¼ãƒ–
            }
        }

        function toggleBook() {
            const modal = document.getElementById('book-modal');
            if (modal.style.display !== 'block') {
                const list = document.getElementById('book-list');
                list.innerHTML = "";
                rarities.forEach(r => {
                    const section = document.createElement('div');
                    section.className = 'book-rarity-section';
                    section.innerHTML = `<h2 style="color:${r.color}">ã€${r.name}ã€‘</h2>`;
                    const grid = document.createElement('div');
                    grid.className = 'book-grid';
                    charDatabase[r.name].forEach(c => {
                        const isKnown = discoveredChars.has(c.name);
                        grid.innerHTML += `<div class="book-card ${isKnown ? '' : 'unknown'}" style="border-color:${isKnown ? r.color : '#222'}">
                            <div class="emoji-book" style="font-size:2rem;">${isKnown ? c.emoji : 'â“'}</div>
                            <div style="font-size:0.75rem; font-weight:bold;">${isKnown ? c.name : 'ï¼Ÿï¼Ÿï¼Ÿ'}</div>
                            <div style="font-size:0.6rem; color:var(--price);">$${r.basePrice.toLocaleString()}</div>
                        </div>`;
                    });
                    section.appendChild(grid);
                    list.appendChild(section);
                });
            }
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        // åˆæœŸåŒ–å‡¦ç†ã®æµã‚Œ
        loadGame();   // ã¾ãšä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        initGrid();   // æ çµ„ã¿ã‚’ä½œã‚‹
        updateUI();   // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºã‚’æ›´æ–°
        setInterval(spawnItem, 250);
    </script>
</body>
</html>